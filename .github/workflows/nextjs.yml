  - name: Detect package manager
    id: detect-package-manager
    run: |
      set -euo pipefail

      # Helper to set outputs (use "." for repo root)
      set_outputs() {
        echo "manager=$1" >> "$GITHUB_OUTPUT"
        echo "command=$2" >> "$GITHUB_OUTPUT"
        echo "runner=$3" >> "$GITHUB_OUTPUT"
        echo "workdir=$4" >> "$GITHUB_OUTPUT"
      }

      # Prefer yarn.lock -> pnpm-lock.yaml -> package.json at repo root
      if [ -f "${GITHUB_WORKSPACE}/yarn.lock" ]; then
        set_outputs "yarn" "install" "yarn" "."
        exit 0
      fi
      if [ -f "${GITHUB_WORKSPACE}/pnpm-lock.yaml" ]; then
        set_outputs "pnpm" "install --frozen-lockfile" "pnpm exec" "."
        exit 0
      fi
      if [ -f "${GITHUB_WORKSPACE}/package.json" ]; then
        set_outputs "npm" "ci" "npx --no-install" "."
        exit 0
      fi

      # Search recursively (first match wins)
      found=$(find "${GITHUB_WORKSPACE}" -type f \( -name "yarn.lock" -o -name "pnpm-lock.yaml" -o -name "package.json" \) -print -quit || true)
      if [ -n "$found" ]; then
        if echo "$found" | grep -q "yarn.lock$"; then
          dir="${found%/yarn.lock}"
          workdir="."
          [ "$dir" != "${GITHUB_WORKSPACE}" ] && workdir="${dir#${GITHUB_WORKSPACE}/}"
          set_outputs "yarn" "install" "yarn" "$workdir"
          exit 0
        elif echo "$found" | grep -q "pnpm-lock.yaml$"; then
          dir="${found%/pnpm-lock.yaml}"
          workdir="."
          [ "$dir" != "${GITHUB_WORKSPACE}" ] && workdir="${dir#${GITHUB_WORKSPACE}/}"
          set_outputs "pnpm" "install --frozen-lockfile" "pnpm exec" "$workdir"
          exit 0
        else
          dir="${found%/package.json}"
          workdir="."
          [ "$dir" != "${GITHUB_WORKSPACE}" ] && workdir="${dir#${GITHUB_WORKSPACE}/}"
          set_outputs "npm" "ci" "npx --no-install" "$workdir"
          exit 0
        fi
      fi

      # Debug output to help troubleshooting
      echo "No package manager files found. Workspace top-level listing:"
      ls -la "${GITHUB_WORKSPACE}" || true
      echo "Searching workspace (first 200 lines):"
      find "${GITHUB_WORKSPACE}" -maxdepth 3 -type f -print | sed -n '1,200p' || true

      echo "Unable to determine package manager"
      exit 1

  - name: Setup Node
    uses: actions/setup-node@v4
    with:
      node-version: "20"
      cache: ${{ steps.detect-package-manager.outputs.manager }}

  - name: Setup Pages
    uses: actions/configure-pages@v5
    with:
      static_site_generator: next

  - name: Restore cache
    uses: actions/cache@v4
    with:
      path: ${{ steps.detect-package-manager.outputs.workdir }}/.next/cache
      key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
      restore-keys: |
        ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}-

  - name: Install dependencies
    run: ${{ steps.detect-package-manager.outputs.manager }} ${{ steps.detect-package-manager.outputs.command }}
    working-directory: ${{ steps.detect-package-manager.outputs.workdir }}

  - name: Build with Next.js
    run: ${{ steps.detect-package-manager.outputs.runner }} next build
    working-directory: ${{ steps.detect-package-manager.outputs.workdir }}

  - name: Upload artifact
    uses: actions/upload-pages-artifact@v3
    with:
      path: ${{ steps.detect-package-manager.outputs.workdir }}/out
